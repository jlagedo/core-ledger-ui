---
applyTo: "src/app/auth/**/*,src/app/services/user-service.ts"
---

# Authentication Instructions

## Authentication System

- Uses Auth0 OIDC via `angular-auth-oidc-client`
- **Two authentication modes** configured in `app.config.ts`:
  1. Mock mode: uses `MockAuthService` and `mockAuthInterceptor`
  2. Real Auth0: uses `OidcSecurityService` and `authInterceptor()`

## Mock Authentication (Development Only)

- **Mock authentication available** for development: set `environment.auth.useMock = true`
- Default environment is `environment.local-noauth.ts` with mock auth enabled
- Mock users: admin, fund-manager, trader, analyst (see `src/app/auth/mock-users.ts`)
- **DO NOT edit `src/app/auth/mock-tokens.ts` manually** - it is auto-generated by CLI tool
- Use `npm run generate-tokens` to regenerate mock tokens after editing mock users

## Production Safety

Mock authentication has multiple security layers to prevent accidental use in production:
1. **Build-Time File Replacement** - Production builds replace `mock-tokens.ts` with error stub
2. **Runtime Environment Check** - `MockAuthService` validates `environment.production` flag
3. **Environment Configuration** - Production environment files disable mock auth by default

## Auth Service Pattern

- `AuthService` uses `toSignal()` to convert OIDC observables to signals
- Exposes `isLoggedIn` and `userProfile` computed signals
- Uses `effect()` to reactively fetch user data from backend on login
- `UserService` fetches user data from backend on login (via reactive `effect()`)

## Route Protection

- All routes protected with `authGuard` (except `/login`)
- Authentication guards check `isLoggedIn` signal
- Unauthenticated users redirected to login page

## User Management

- `UserService` manages user data from backend database
- User data includes permissions, roles, and profile information
- User data is fetched on login and cached in service signals
