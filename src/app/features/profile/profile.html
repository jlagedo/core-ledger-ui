<app-page-header title="User Profile" />

<main class="profile container-fluid px-3 pb-4">

  <!-- ============================================================
       IDENTITY CARD (Hero Section)
       ============================================================ -->
  <section class="terminal-panel" style="animation-delay: 0.1s">
    <header class="terminal-panel__header">
      <h2 class="terminal-panel__title">
        <span class="fn-key">USR</span>
        Identity
      </h2>
      <div class="terminal-panel__actions">
        <span class="data-grid__value data-grid__value--success" style="font-size: 0.625rem;">
          <i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i>
          Online
        </span>
      </div>
    </header>
    <div class="identity-card">
      <div class="identity-card__avatar">
        @if (userProfile()?.picture) {
          <img
            [src]="userProfile()!.picture"
            [alt]="userProfile()!.name"
            referrerpolicy="no-referrer"
          />
        } @else {
          <div class="avatar-placeholder">
            <i class="bi bi-person"></i>
          </div>
        }
        <span class="identity-card__status" title="Online"></span>
      </div>

      <div class="identity-card__info">
        <h1 class="identity-card__name">{{ userProfile()?.name ?? 'Unknown User' }}</h1>
        <p class="identity-card__email">{{ userProfile()?.email ?? 'No email' }}</p>
        <span class="identity-card__role">
          <i class="bi bi-shield-check"></i>
          {{ userRole() }}
        </span>
      </div>

      <div class="identity-card__meta">
        <div class="identity-card__meta-item">
          <span class="label">Member Since</span>
          <span class="value">{{ memberSince() | date:'MMM yyyy' }}</span>
        </div>
        <div class="identity-card__meta-item">
          <span class="label">Last Login</span>
          <span class="value">{{ formatRelativeTime(lastLogin()) }}</span>
        </div>
        <div class="identity-card__meta-item">
          <span class="label">Sessions</span>
          <span class="value">{{ sessions().length }}</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ============================================================
       ACCOUNT DETAILS GRID
       ============================================================ -->
  <section class="terminal-panel" style="animation-delay: 0.15s">
    <header class="terminal-panel__header">
      <h2 class="terminal-panel__title">
        <span class="fn-key">F5</span>
        Account Details
      </h2>
    </header>
    <div class="terminal-panel__body p-0">
      <div class="data-grid data-grid--3col">
        <div class="data-grid__item">
          <div class="data-grid__label">Full Name</div>
          <div class="data-grid__value">{{ userProfile()?.name ?? '—' }}</div>
        </div>
        <div class="data-grid__item">
          <div class="data-grid__label">Email Address</div>
          <div class="data-grid__value">{{ userProfile()?.email ?? '—' }}</div>
        </div>
        <div class="data-grid__item">
          <div class="data-grid__label">Role</div>
          <div class="data-grid__value data-grid__value--accent">{{ userRole() }}</div>
        </div>
        <div class="data-grid__item">
          <div class="data-grid__label">User ID</div>
          <div class="data-grid__value data-grid__value--mono">{{ userProfile()?.sub ?? '—' }}</div>
        </div>
        <div class="data-grid__item">
          <div class="data-grid__label">Auth Provider</div>
          <div class="data-grid__value">Auth0 OIDC</div>
        </div>
        <div class="data-grid__item">
          <div class="data-grid__label">MFA Status</div>
          <div class="data-grid__value data-grid__value--success">Enabled</div>
        </div>
      </div>
    </div>
  </section>

  <div class="row g-3">
    <!-- ============================================================
         ACTIVE SESSIONS
         ============================================================ -->
    <div class="col-lg-6">
      <section class="terminal-panel" style="animation-delay: 0.2s">
        <header class="terminal-panel__header">
          <h2 class="terminal-panel__title">
            <span class="fn-key">F6</span>
            Active Sessions
          </h2>
          <button class="btn btn-sm btn-link text-secondary p-1" title="Refresh">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </header>
        <div class="terminal-panel__body">
          <ul class="session-list">
            @for (session of sessions(); track session.id) {
              <li class="session-list__item" [class.session-list__item--current]="session.isCurrent">
                <div class="session-list__icon">
                  <i class="bi {{ getDeviceIcon(session.device) }}"></i>
                </div>
                <div class="session-list__info">
                  <div class="session-list__device">
                    {{ session.device }}
                    @if (session.isCurrent) {
                      <span class="text-body-secondary">(this device)</span>
                    }
                  </div>
                  <div class="session-list__details">
                    {{ session.browser }} · {{ session.location }} · {{ session.ip }}
                  </div>
                </div>
                @if (session.isCurrent) {
                  <span class="session-list__status session-list__status--active">Active</span>
                } @else {
                  <button
                    class="btn btn-sm btn-link text-secondary p-1"
                    title="Revoke session"
                    (click)="revokeSession(session.id)"
                  >
                    <i class="bi bi-x-lg"></i>
                  </button>
                }
              </li>
            }
          </ul>
        </div>
      </section>
    </div>

    <!-- ============================================================
         QUICK ACTIONS
         ============================================================ -->
    <div class="col-lg-6">
      <section class="terminal-panel" style="animation-delay: 0.25s">
        <header class="terminal-panel__header">
          <h2 class="terminal-panel__title">Security Actions</h2>
        </header>
        <div class="terminal-panel__body">
          <div class="quick-actions">
            @for (action of quickActions(); track action.key) {
              <button
                class="quick-actions__btn"
                [class.quick-actions__btn--danger]="action.isDanger"
                (click)="handleAction(action.action)"
              >
                <span class="quick-actions__key">{{ action.key }}</span>
                <span class="quick-actions__label">{{ action.label }}</span>
                <i class="quick-actions__icon bi {{ action.icon }}"></i>
              </button>
            }
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="row g-3">
    <!-- ============================================================
         ACTIVITY LOG
         ============================================================ -->
    <div class="col-lg-8">
      <section class="terminal-panel" style="animation-delay: 0.3s">
        <header class="terminal-panel__header">
          <h2 class="terminal-panel__title">
            <span class="fn-key">F7</span>
            Activity Log
          </h2>
          <button class="btn btn-sm btn-link text-secondary p-1" title="View All">
            <i class="bi bi-arrow-right"></i>
          </button>
        </header>
        <div class="terminal-panel__body">
          <ul class="activity-log">
            @for (item of activityLog(); track item.id) {
              <li class="activity-log__item">
                <span class="activity-log__time">{{ formatRelativeTime(item.time) }}</span>
                <span class="activity-log__action">
                  {{ item.action }}
                  @if (item.entity) {
                    <span class="pipe">|</span>
                    <span class="entity">{{ item.entity }}</span>
                  }
                </span>
                <i class="activity-log__icon bi {{ getActivityIcon(item.type) }} {{ getActivityIconClass(item.type) }}"></i>
              </li>
            }
          </ul>
        </div>
      </section>
    </div>

    <!-- ============================================================
         PREFERENCES
         ============================================================ -->
    <div class="col-lg-4">
      <section class="terminal-panel" style="animation-delay: 0.35s">
        <header class="terminal-panel__header">
          <h2 class="terminal-panel__title">
            <span class="fn-key">F8</span>
            Preferences
          </h2>
        </header>
        <div class="terminal-panel__body">
          <ul class="pref-list">
            @for (pref of preferences(); track pref.id) {
              <li class="pref-list__item">
                <div class="pref-list__info">
                  <div class="pref-list__label">{{ pref.label }}</div>
                  <div class="pref-list__desc">{{ pref.description }}</div>
                </div>
                <div class="pref-list__control">
                  <div class="form-check form-switch mb-0">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      role="switch"
                      [id]="pref.id"
                      [checked]="pref.enabled"
                      (change)="togglePreference(pref.id)"
                    />
                  </div>
                </div>
              </li>
            }
          </ul>
        </div>
      </section>
    </div>
  </div>

</main>
