<app-page-header title="Nova Transação">
  <button class="btn btn-sm btn-secondary" aria-label="Obter ajuda para esta página">
    <i class="bi bi-question-circle"></i> Ajuda
  </button>
</app-page-header>

<main class="container-form-wide">
  <div class="card-form">
    <div class="card-header">
      <h5 class="card-title">Criar Transação</h5>
    </div>
    <div class="card-body">

      <form (ngSubmit)="onSubmit()" [formGroup]="transactionForm" class="row g-3" novalidate>
        <!-- Fund and Security Selection -->
        <div class="col-12">
          <div class="row">
          <div class="col-md-6">
            <label class="form-label" for="fundId">Fundo <span class="text-danger">*</span></label>
            <select [class.is-invalid]="isInvalid('fundId')" class="form-select" formControlName="fundId" id="fundId">
              <option [ngValue]="null">Selecione um fundo...</option>
              @for (fund of funds(); track fund.id) {
                <option [ngValue]="fund.id">{{ fund.code }} - {{ fund.name }}</option>
              }
            </select>
            @if (isInvalid('fundId')) {
              <div class="invalid-feedback">
                @if (hasError('fundId', 'required')) {
                  Fundo é obrigatório
                }
              </div>
            }
          </div>
          <div class="col-md-6">
            <label class="form-label" for="securityId">Segurança</label>
            <select class="form-select" formControlName="securityId" id="securityId">
              <option [ngValue]="null">Nenhuma (Transação de caixa)</option>
              @for (security of securities(); track security.id) {
                <option [ngValue]="security.id">{{ security.ticker }} - {{ security.name }}</option>
              }
            </select>
          </div>
          </div>
        </div>

        <!-- Transaction Type -->
        <div class="col-12">
          <div class="row">
          <div class="col-md-6">
            <label class="form-label" for="transactionSubTypeId">Tipo de Transação <span class="text-danger">*</span></label>
            <select [class.is-invalid]="isInvalid('transactionSubTypeId')" class="form-select" formControlName="transactionSubTypeId" id="transactionSubTypeId">
              <option [ngValue]="null">Selecione um tipo...</option>
              @for (subType of transactionSubTypes(); track subType.id) {
                <option [ngValue]="subType.id">{{ subType.typeDescription }} - {{ subType.shortDescription }}</option>
              }
            </select>
            @if (isInvalid('transactionSubTypeId')) {
              <div class="invalid-feedback">
                @if (hasError('transactionSubTypeId', 'required')) {
                  Tipo de transação é obrigatório
                }
              </div>
            }
          </div>
          <div class="col-md-6">
            <label class="form-label" for="currency">Moeda <span class="text-danger">*</span></label>
            <input [class.is-invalid]="isInvalid('currency')" class="form-control text-uppercase font-monospace text-info text-nowrap" formControlName="currency"
                   id="currency" maxlength="3" placeholder="USD" type="text">
            @if (isInvalid('currency')) {
              <div class="invalid-feedback">
                @if (hasError('currency', 'required')) {
                  Moeda é obrigatória
                }
                @if (hasError('currency', 'minlength') || hasError('currency', 'maxlength')) {
                  Moeda deve ser um código ISO de 3 letras
                }
              </div>
            }
          </div>
          </div>
        </div>

        <!-- Trade and Settle Dates -->
        <div class="col-12">
          <div class="row">
          <div class="col-md-6">
            <label class="form-label" for="tradeDate">Data da Negociação <span class="text-danger">*</span></label>
            <div class="input-group">
              <input #tdPicker="ngbDatepicker" [class.is-invalid]="isInvalid('tradeDate')" class="form-control font-monospace text-nowrap" formControlName="tradeDate"
                     id="tradeDate" ngbDatepicker placeholder="yyyy-mm-dd" type="text">
              <button (click)="tdPicker.toggle()" [attr.aria-label]="'Abrir calendário'" class="btn btn-outline-secondary" type="button">
                <i aria-hidden="true" class="bi bi-calendar3"></i>
              </button>
            </div>
            @if (isInvalid('tradeDate')) {
              <div class="invalid-feedback d-block">
                @if (hasError('tradeDate', 'required')) {
                  Data da negociação é obrigatória
                }
              </div>
            }
          </div>
          <div class="col-md-6">
            <label class="form-label" for="settleDate">Data de Liquidação <span class="text-danger">*</span></label>
            <div class="input-group">
              <input #sdPicker="ngbDatepicker" [class.is-invalid]="isInvalid('settleDate')" class="form-control font-monospace text-nowrap" formControlName="settleDate"
                     id="settleDate" ngbDatepicker placeholder="yyyy-mm-dd" type="text">
              <button (click)="sdPicker.toggle()" [attr.aria-label]="'Abrir calendário'" class="btn btn-outline-secondary" type="button">
                <i aria-hidden="true" class="bi bi-calendar3"></i>
              </button>
            </div>
            @if (isInvalid('settleDate')) {
              <div class="invalid-feedback d-block">
                @if (hasError('settleDate', 'required')) {
                  Data de liquidação é obrigatória
                }
              </div>
            }
          </div>
          </div>
        </div>

        <!-- Quantity, Price, Amount -->
        <div class="col-12">
          <div class="row">
          <div class="col-md-4">
            <label class="form-label" for="quantity">Quantidade <span class="text-danger">*</span></label>
            <input [class.is-invalid]="isInvalid('quantity')" class="form-control text-end font-monospace text-nowrap" formControlName="quantity"
                   id="quantity" placeholder="0" type="text">
            @if (isInvalid('quantity')) {
              <div class="invalid-feedback">
                @if (hasError('quantity', 'required')) {
                  Quantidade é obrigatória
                }
                @if (hasError('quantity', 'pattern')) {
                  Quantidade deve ser um número válido
                }
              </div>
            }
          </div>
          <div class="col-md-4">
            <label class="form-label" for="price">Preço <span class="text-danger">*</span></label>
            <input [class.is-invalid]="isInvalid('price')" class="form-control text-end font-monospace text-nowrap" formControlName="price"
                   id="price" placeholder="0.00" type="text">
            @if (isInvalid('price')) {
              <div class="invalid-feedback">
                @if (hasError('price', 'required')) {
                  Preço é obrigatório
                }
                @if (hasError('price', 'pattern')) {
                  Preço deve ser um número positivo
                }
              </div>
            }
          </div>
          <div class="col-md-4">
            <label class="form-label" for="amount">Valor <span class="text-danger">*</span></label>
            <input [class.is-invalid]="isInvalid('amount')" class="form-control text-end font-monospace fw-bold text-nowrap" formControlName="amount"
                   id="amount" placeholder="0.00" type="text">
            <small class="text-muted">Calculado automaticamente de Qtd × Preço</small>
            @if (isInvalid('amount')) {
              <div class="invalid-feedback">
                @if (hasError('amount', 'required')) {
                  Valor é obrigatório
                }
                @if (hasError('amount', 'pattern')) {
                  Valor deve ser um número válido
                }
              </div>
            }
          </div>
          </div>
        </div>

        <!-- Loading Status Message -->
        <div class="col-12">
          @if (submitStatus() === 'loading') {
            <div class="alert alert-info d-flex align-items-center" role="status">
              <div aria-hidden="true" class="spinner-border spinner-border-sm me-2 text-primary"></div>
              <div>
                Criando transação...
              </div>
            </div>
          }
        </div>

        <div class="col-12">
          <div class="d-flex gap-2 align-items-center">
          <button [disabled]="isSubmitting()" class="btn btn-primary position-relative" type="submit">
            @if (isSubmitting()) {
              <span aria-hidden="true" class="spinner-border spinner-border-sm me-1"></span>
            }
            Enviar
          </button>
          <button (click)="cancel()" class="btn btn-secondary" type="button">
            Cancelar e Voltar
          </button>
          <button (click)="clearForm()" [disabled]="isSubmitting()" class="btn btn-outline-secondary" type="button">
            Limpar
          </button>
          </div>
        </div>
      </form>

      <!-- ARIA Live Region for Screen Reader Announcements -->
      <div aria-atomic="true" aria-live="polite" class="visually-hidden" role="status">
        @if (submitStatus() === 'loading') {
          Criando transação, por favor aguarde...
        }
        @if (submitStatus() === 'success') {
          Transação criada com sucesso. Redirecionando para Lista de Transações...
        }
        @if (submitStatus() === 'error') {
          Erro: {{ errorMessage() }}
        }
      </div>

      <!-- Success Message -->
      @if (submitStatus() === 'success') {
        <div class="alert alert-success d-flex align-items-center mb-3" role="alert">
          <i aria-hidden="true" class="bi bi-check-circle-fill fs-4 me-2"></i>
          <div>
            <strong>Sucesso!</strong> Transação criada com sucesso. Redirecionando para Lista de Transações...
          </div>
        </div>
      }

      <!-- Error Message -->
      @if (submitStatus() === 'error') {
        <div class="alert alert-danger d-flex align-items-start mb-3" role="alert">
          <i aria-hidden="true" class="bi bi-exclamation-triangle-fill fs-4 me-2 flex-shrink-0"></i>
          <div class="flex-grow-1">
            <strong>Erro!</strong> {{ errorMessage() }}
            <div class="mt-2">
              <button (click)="retrySubmit()" class="btn btn-sm btn-outline-danger" type="button">
                <i aria-hidden="true" class="bi bi-arrow-clockwise me-1"></i>
                Tentar Novamente
              </button>
            </div>
          </div>
        </div>
      }

    </div>
  </div>
</main>
